<!-- FILE: ui/ui1_2_temporal.html (Updated with ASR Search Support) -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCubee2 Video Search System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #0f172a; color: #e2e8f0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .top-toolbar { position: fixed; top: 0; left: 0; width: 100%; background: rgba(15, 23, 42, 0.95); padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; z-index: 100; border-bottom: 1px solid rgba(94, 234, 212, 0.3); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); }
        .toolbar-left, .toolbar-right { display: flex; gap: 20px; align-items: center; }
        .toolbar-btn { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(94, 234, 212, 0.3); color: #5eead4; padding: 10px 18px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; font-size: 0.95rem; position: relative; }
        .toolbar-btn:hover { background: rgba(56, 189, 248, 0.2); transform: translateY(-2px); color: #38bdf8; border-color: #38bdf8; }
        .toolbar-btn.active { background: rgba(22, 163, 74, 0.2); border-color: #22c55e; color: #22c55e; font-weight: 600; }
        .app-title { font-size: 1.6rem; font-weight: 700; background: linear-gradient(to right, #38bdf8, #0ea5e9); -webkit-background-clip: text; background-clip: text; color: transparent; display: flex; align-items: center; gap: 10px; }
        .main-content-wrapper { display: flex; flex-grow: 1; padding-top: 75px; height: 100vh; }
        #left-search-panel { width: 360px; flex-shrink: 0; background: #0f172a; border-right: 1px solid rgba(94, 234, 212, 0.2); padding: 20px; display: flex; flex-direction: column; }
        #right-results-panel { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(94, 234, 212, 0.2); flex-shrink: 0; }
        .panel-title { font-size: 1.5rem; font-weight: 600; color: #38bdf8; }
        .stages-container { display: flex; flex-direction: column; gap: 20px; padding-top: 10px; overflow-y: auto; padding-right: 10px; flex-grow: 1; }
        .stage-card { background: rgba(30, 41, 59, 0.7); border-radius: 12px; padding: 20px; position: relative; border: 1px solid rgba(94, 234, 212, 0.2); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); flex-shrink: 0; }
        .stage-number { position: absolute; top: -12px; left: 20px; background: linear-gradient(to right, #0ea5e9, #38bdf8); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; color: white; }
        .stage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .query-types { display: flex; gap: 8px; }
        .type-btn { width: 40px; height: 40px; font-size: 1.1rem; background: rgba(30, 41, 59, 0.9); border: 1px solid rgba(94, 234, 212, 0.3); border-radius: 10px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; color: #94a3b8; }
        .delete-stage { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; width: 30px; height: 30px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .delete-stage:hover { background: rgba(239, 68, 68, 0.2); transform: scale(1.1); }
        .type-btn.active { background: rgba(56, 189, 248, 0.2); border-color: #38bdf8; color: #38bdf8; transform: translateY(-3px); box-shadow: 0 4px 10px rgba(56, 189, 248, 0.3); }
        .type-btn:hover:not(.active) { border-color: #5eead4; color: #5eead4; }
        /* Special styling for ASR button */
        .type-btn[data-type="asr"].active { background: rgba(168, 85, 247, 0.2); border-color: #a855f7; color: #a855f7; }
        .type-btn[data-type="asr"]:hover:not(.active) { border-color: #c084fc; color: #c084fc; }
        .stage-options { display: flex; gap: 10px; margin-top: 15px; }
        .option-btn { background: rgba(30, 41, 59, 0.7); border: 1px solid #475569; color: #94a3b8; padding: 6px 14px; border-radius: 8px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s ease; }
        .option-btn.active { background: rgba(22, 163, 74, 0.2); border-color: #22c55e; color: #22c55e; font-weight: 600; }
        .option-btn:hover:not(.active) { border-color: #64748b; }
        .panel-controls { display: flex; justify-content: space-between; align-items: center; margin-top: auto; flex-shrink: 0; padding-top: 20px; }
        .stage-controls { display: flex; gap: 15px; }
        .control-btn { width: 50px; height: 50px; border-radius: 12px; border: 1px solid rgba(94, 234, 212, 0.3); background: rgba(30, 41, 59, 0.7); color: #5eead4; font-size: 1.4rem; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .control-btn:hover { background: rgba(56, 189, 248, 0.2); transform: scale(1.05); color: #38bdf8; border-color: #38bdf8; }
        .search-btn { background: linear-gradient(to right, #0ea5e9, #38bdf8); color: white; border: none; padding: 14px 40px; border-radius: 12px; font-weight: 600; font-size: 1.1rem; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4); }
        .search-btn:hover { transform: translateY(-3px); box-shadow: 0 7px 20px rgba(14, 165, 233, 0.6); }
        .query-input-area { margin-top: 15px; position: relative; }
        .stage-input { width: 100%; padding: 14px 18px; background: rgba(15, 23, 42, 0.7); border: 1px solid rgba(94, 234, 212, 0.3); border-radius: 10px; color: white; font-size: 1.0rem; line-height: 1.5; resize: vertical; min-height: 100px; }
        .stage-input:focus { outline: none; border-color: #38bdf8; box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2); }
        .stage-input-file { display: none; }
        .image-upload-zone { display: none; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 150px; border: 2px dashed #475569; border-radius: 10px; background-color: rgba(15, 23, 42, 0.5); color: #94a3b8; cursor: pointer; transition: border-color 0.3s ease, background-color 0.3s ease; position: relative; overflow: hidden; }
        .image-upload-zone.dragover { border-color: #38bdf8; background-color: rgba(56, 189, 248, 0.1); }
        .image-upload-zone:hover { border-color: #5eead4; }
        .image-upload-zone i { font-size: 2.5rem; margin-bottom: 10px; }
        .image-upload-zone p { font-size: 0.9rem; text-align: center; }
        .image-preview { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        .remove-image-btn { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255, 255, 255, 0.3); color: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; font-size: 0.9rem; z-index: 2; }
        .remove-image-btn:hover { background: #ef4444; color: white; border-color: transparent; }
        .model-dropdown { display: none; position: absolute; top: 110%; right: 0; background: #1e293b; border: 1px solid rgba(94, 234, 212, 0.3); border-radius: 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.3); padding: 8px; z-index: 101; width: 150px; }
        .model-dropdown-item { display: flex; align-items: center; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        .model-dropdown-item:hover { background-color: rgba(56, 189, 248, 0.1); }
        .model-dropdown-item input[type="checkbox"] { margin-right: 10px; accent-color: #38bdf8; }
        .model-dropdown-item label { cursor: pointer; user-select: none; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 15px; }
        .result-item { background: #1e293b; border-radius: 10px; overflow: hidden; border: 1px solid rgba(94, 234, 212, 0.2); transition: transform 0.3s ease, box-shadow 0.3s ease; aspect-ratio: 16 / 9; }
        .result-item:hover { transform: scale(1.05); box-shadow: 0 8px 25px rgba(56, 189, 248, 0.2); border-color: #38bdf8; }
        .result-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .cluster-separator { border: 0; height: 1px; background: rgba(94, 234, 212, 0.2); margin: 30px 0 20px 0; }
        .cluster-header { color: #5eead4; font-size: 1.1rem; font-weight: 600; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid rgba(94, 234, 212, 0.25); display: flex; align-items: center; gap: 10px; }
        .cluster-header i { font-size: 1.2rem; }
        /* ASR-specific header styling */
        .cluster-header.asr-header { color: #a855f7; border-bottom-color: rgba(168, 85, 247, 0.25); }
    </style>
</head>
<body>
    <div class="top-toolbar">
        <div class="toolbar-left"><div class="app-title"><i class="fas fa-video"></i> OpenCubee</div></div>
        <div class="toolbar-right">
            <div id="modelSelectBtn" class="toolbar-btn"><i class="fas fa-layer-group"></i> Models
                <div id="modelDropdown" class="model-dropdown">
                    <div class="model-dropdown-item"><input type="checkbox" id="model-beit3" value="beit3" checked><label for="model-beit3">BEiT-3</label></div>
                    <div class="model-dropdown-item"><input type="checkbox" id="model-bge" value="bge" checked><label for="model-bge">BGE</label></div>
                </div>
            </div>
            <button class="toolbar-btn" id="clusterBtn" title="Toggle Clustering (G)"><i class="fas fa-object-group"></i> Cluster</button>
            <button class="toolbar-btn" id="resetBtn"><i class="fas fa-redo"></i> Reset Stages</button>
            <button class="toolbar-btn" id="exitBtn"><i class="fas fa-power-off"></i> Exit</button>
        </div>
    </div>
    <div class="main-content-wrapper">
        <div id="left-search-panel">
            <div class="panel-header"><h2 class="panel-title">Advanced Search Panel</h2></div>
            <div class="stages-container" id="stagesContainer"></div>
            <div class="panel-controls" style="border-top: 1px solid rgba(94, 234, 212, 0.2); padding-top: 20px;">
                <div class="stage-controls"><button class="control-btn" id="addStageBtn" title="Add Stage (+)"><i class="fas fa-plus"></i></button><button class="control-btn" id="removeStageBtn" title="Remove Stage (-)"><i class="fas fa-minus"></i></button></div>
                <button class="search-btn" id="searchBtn" title="Search (Enter from input)"><i class="fas fa-search"></i> Search</button>
            </div>
        </div>
        <div id="right-results-panel">
            <div id="loadingIndicator" style="display: none; text-align: center; font-size: 1.2rem; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Performing Search...</div>
            <div id="resultsContainer"><p style="text-align: center; color: #94a3b8; padding-top: 50px; font-size: 1.2rem;">Sử dụng bảng điều khiển bên trái để bắt đầu tìm kiếm.</p></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let currentResults = [];
        let searchType = null;
        const stagesContainer = document.getElementById('stagesContainer'); const addStageBtn = document.getElementById('addStageBtn'); const removeStageBtn = document.getElementById('removeStageBtn'); const searchBtn = document.getElementById('searchBtn'); const resultsContainer = document.getElementById('resultsContainer'); const loadingIndicator = document.getElementById('loadingIndicator'); const modelSelectBtn = document.getElementById('modelSelectBtn'); const modelDropdown = document.getElementById('modelDropdown'); const clusterBtn = document.getElementById('clusterBtn');
        
        clusterBtn.addEventListener('click', () => { clusterBtn.classList.toggle('active'); displayResults(); });
        modelSelectBtn.addEventListener('click', (event) => { event.stopPropagation(); modelDropdown.style.display = modelDropdown.style.display === 'block' ? 'none' : 'block'; });
        window.addEventListener('click', () => { modelDropdown.style.display = 'none'; });
        
        const queryTypes = [ 
            { id: 'text', icon: 'fas fa-font', label: 'Text (T)' }, 
            { id: 'image', icon: 'fas fa-image', label: 'Image (I)' }, 
            { id: 'ocr', icon: 'fas fa-text-height', label: 'OCR (O)' }, 
            { id: 'asr', icon: 'fas fa-microphone', label: 'ASR (A)' }, 
            { id: 'object', icon: 'fas fa-shapes', label: 'Object Filter' }
        ];
        
        function createStageCard(number) {
            const stageCard = document.createElement('div'); stageCard.className = 'stage-card'; stageCard.dataset.stageNumber = number; let typesHTML = queryTypes.map(type => `<button class="type-btn ${type.id === 'text' ? 'active' : ''}" data-type="${type.id}" title="${type.label}"><i class="${type.icon}"></i></button>`).join('');
            const inputHTML = `<textarea class="stage-input" placeholder="Nhập truy vấn cho stage này..." rows="4"></textarea>`;
            stageCard.innerHTML = `
                <div class="stage-number">${number}</div>
                <div class="stage-header"><div class="query-types">${typesHTML}</div><button class="delete-stage" title="Delete Stage"><i class="fas fa-times"></i></button></div>
                <div class="query-input-area">${inputHTML}<label for="file-input-${number}" class="image-upload-zone"><div class="upload-instructions"><i class="fas fa-cloud-upload-alt"></i><p>Kéo & thả ảnh hoặc <strong>nhấn để chọn file</strong></p></div><img class="image-preview" style="display: none;"><button class="remove-image-btn" style="display: none;" title="Xóa ảnh"><i class="fas fa-times"></i></button></label><input type="file" id="file-input-${number}" class="stage-input-file" accept="image/*"></div>
                <div class="stage-options"><button class="option-btn" data-option="enhance" title="Enhance Query (Q)">Enhance Query</button><button class="option-btn" data-option="expand" title="Expand Query (E)">Expand Query</button></div>`;
            const textInput = stageCard.querySelector('.stage-input'), imageUploadZone = stageCard.querySelector('.image-upload-zone');
            
            const updateInputVisibility = () => {
                const imageIsActive = stageCard.querySelector('.type-btn[data-type="image"].active');
                textInput.style.display = imageIsActive ? 'none' : 'block'; imageUploadZone.style.display = imageIsActive ? 'flex' : 'none';
                
                // Update placeholder text based on search type
                const activeType = stageCard.querySelector('.type-btn.active')?.dataset.type;
                switch(activeType) {
                    case 'text':
                        textInput.placeholder = 'Nhập truy vấn văn bản...';
                        break;
                    case 'ocr':
                        textInput.placeholder = 'Nhập từ khóa để tìm trong văn bản OCR...';
                        break;
                    case 'asr':
                        textInput.placeholder = 'Nhập từ khóa để tìm trong văn bản ASR (speech-to-text)...';
                        break;
                    default:
                        textInput.placeholder = 'Nhập truy vấn cho stage này...';
                }
            };
            
            stageCard.querySelectorAll('.type-btn').forEach(button => { button.addEventListener('click', () => { stageCard.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active')); button.classList.add('active'); updateInputVisibility(); }); });
            const handleFileSelect = (file) => { if (file && file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = e => { const previewImage = stageCard.querySelector('.image-preview'), uploadInstructions = stageCard.querySelector('.upload-instructions'), removeImageBtn = stageCard.querySelector('.remove-image-btn'); previewImage.src = e.target.result; previewImage.style.display = 'block'; uploadInstructions.style.display = 'none'; removeImageBtn.style.display = 'flex'; }; reader.readAsDataURL(file); stageCard.selectedImageFile = file; } };
            stageCard.querySelector('.remove-image-btn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); stageCard.querySelector('.stage-input-file').value = ''; const previewImage = stageCard.querySelector('.image-preview'), uploadInstructions = stageCard.querySelector('.upload-instructions'), removeImageBtn = stageCard.querySelector('.remove-image-btn'); previewImage.src = ''; previewImage.style.display = 'none'; uploadInstructions.style.display = 'block'; removeImageBtn.style.display = 'none'; delete stageCard.selectedImageFile; });
            stageCard.querySelector('.stage-input-file').addEventListener('change', e => handleFileSelect(e.target.files[0]));
            const dropZone = stageCard.querySelector('.image-upload-zone');
            dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.classList.remove('dragover'); });
            dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFileSelect(e.dataTransfer.files[0]); });
            stageCard.querySelector('.delete-stage').addEventListener('click', () => { stageCard.remove(); renumberStages(); });
            stageCard.querySelectorAll('.option-btn').forEach(button => button.addEventListener('click', () => button.classList.toggle('active')));
            updateInputVisibility(); return stageCard;
        }
        function renumberStages() { stagesContainer.querySelectorAll('.stage-card').forEach((card, index) => { card.querySelector('.stage-number').textContent = index + 1; }); }
        function addStage() { stagesContainer.appendChild(createStageCard(stagesContainer.children.length + 1)); }
        function removeStage() { if (stagesContainer.children.length > 1) { stagesContainer.lastChild.remove(); } }
        
        async function handleSearch() {
            const allStages = stagesContainer.querySelectorAll('.stage-card');
            if (allStages.length === 0) { alert('Vui lòng thêm ít nhất một stage tìm kiếm.'); return; }
            loadingIndicator.style.display = 'block'; resultsContainer.innerHTML = '';
            try {
                // Bước 1: Xử lý trước query nếu cần và cập nhật UI
                for (const stage of allStages) {
                    const queryInput = stage.querySelector('.stage-input');
                    const isEnhanced = stage.querySelector('.option-btn[data-option="enhance"]').classList.contains('active');
                    const isExpanded = stage.querySelector('.option-btn[data-option="expand"]').classList.contains('active');
                    const queryText = queryInput.value.trim();
                    if (queryText && (isEnhanced || isExpanded)) {
                        const processResponse = await fetch('/process_query', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ query: queryText, enhance: isEnhanced, expand: isExpanded })
                        });
                        if (!processResponse.ok) throw new Error("Lỗi khi xử lý query.");
                        const data = await processResponse.json();
                        queryInput.value = data.processed_query; // Cập nhật text box
                    }
                }
                
                // Bước 2: Tiến hành tìm kiếm với dữ liệu đã được cập nhật
                const selectedModels = Array.from(document.querySelectorAll('#modelDropdown input:checked')).map(cb => cb.value);
                const firstStage = allStages[0];
                const isOcrSearch = firstStage.querySelector('.type-btn[data-type="ocr"].active');
                const isAsrSearch = firstStage.querySelector('.type-btn[data-type="asr"].active');
                
                if (!isOcrSearch && !isAsrSearch && selectedModels.length === 0) { 
                    throw new Error("Vui lòng chọn ít nhất một model để tìm kiếm."); 
                }
                
                let response; searchType = null;
                
                if (isOcrSearch) {
                    searchType = 'ocr';
                    const query = firstStage.querySelector('.stage-input').value.trim();
                    if (query === '') throw new Error("Vui lòng nhập từ khóa cho OCR search.");
                    const isEnhanced = firstStage.querySelector('.option-btn[data-option="enhance"]').classList.contains('active');
                    const isExpanded = firstStage.querySelector('.option-btn[data-option="expand"]').classList.contains('active');
                    response = await fetch('/ocr_search', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ query, enhance: isEnhanced, expand: isExpanded }) 
                    });
                } else if (isAsrSearch) {
                    searchType = 'asr';
                    const query = firstStage.querySelector('.stage-input').value.trim();
                    if (query === '') throw new Error("Vui lòng nhập từ khóa cho ASR search.");
                    const isEnhanced = firstStage.querySelector('.option-btn[data-option="enhance"]').classList.contains('active');
                    const isExpanded = firstStage.querySelector('.option-btn[data-option="expand"]').classList.contains('active');
                    response = await fetch('/asr_search', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ query, enhance: isEnhanced, expand: isExpanded }) 
                    });
                } else if (allStages.length === 1) {
                    searchType = 'simple';
                    const queryText = firstStage.querySelector('.stage-input').value.trim();
                    const imageFile = firstStage.selectedImageFile;
                    if (!queryText && !imageFile) throw new Error("Vui lòng nhập text hoặc chọn ảnh.");
                    const formData = new FormData();
                    if (queryText) formData.append('query_text', queryText);
                    if (imageFile) formData.append('query_image', imageFile, imageFile.name);
                    selectedModels.forEach(model => formData.append('models', model));
                    formData.append('enhance', false); formData.append('expand', false);
                    response = await fetch('/search', { method: 'POST', body: formData });
                } else {
                    searchType = 'temporal';
                    const stagesData = [];
                    for (const stage of allStages) {
                        const query = stage.querySelector('.stage-input').value.trim();
                        if (query === '') throw new Error(`Vui lòng nhập từ khóa cho stage ${stage.dataset.stageNumber}.`);
                        stagesData.push({ query, enhance: false, expand: false });
                    }
                    const payload = { stages: stagesData, models: selectedModels };
                    response = await fetch('/temporal_search', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                }
                if (!response.ok) { const err = await response.json(); throw new Error(err.detail || 'Lỗi không xác định từ server.'); }
                currentResults = await response.json();
                displayResults();
            } catch (error) {
                console.error("Lỗi khi tìm kiếm:", error);
                resultsContainer.innerHTML = `<p style="color: #ef4444; font-size: 1.1rem; text-align: center;"><strong>Lỗi:</strong> ${error.message}</p>`;
                currentResults = [];
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
        
        function displayResults() {
            resultsContainer.innerHTML = '';
            const data = currentResults;
            if (!Array.isArray(data) || data.length === 0) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: #94a3b8;">Không tìm thấy kết quả.</p>';
                return;
            }
            const isClusteredMode = clusterBtn.classList.contains('active');
            const createItemHTML = (shot) => `<img src="${shot.url}" alt="Search Result" title="Filepath: ${shot.filepath}\nShot ID: ${shot.shot_id || 'N/A'}\nScore: ${(shot.rrf_score || shot.score || 0).toFixed(4)}" loading="lazy" onerror="this.parentElement.style.display='none'">`;
            
            if (searchType === 'temporal') {
                data.forEach((sequence, index) => {
                    if (index > 0) resultsContainer.appendChild(document.createElement('hr')).className = 'cluster-separator';
                    if (sequence.shots && sequence.shots.length > 0) {
                        const videoId = sequence.shots[0].video_id;
                        const header = document.createElement('div');
                        header.className = 'cluster-header';
                        header.innerHTML = `<i class="fas fa-film"></i> Sequence from Video: ${videoId}`;
                        resultsContainer.appendChild(header);
                    }
                    const grid = document.createElement('div'); grid.className = 'results-grid';
                    (sequence.shots || []).forEach(shot => {
                        const item = document.createElement('div'); item.className = 'result-item';
                        item.innerHTML = createItemHTML(shot);
                        grid.appendChild(item);
                    });
                    resultsContainer.appendChild(grid);
                });
            } else if (searchType === 'asr') {
                // Special handling for ASR results
                if (isClusteredMode) {
                    data.forEach((cluster, index) => {
                        if (index > 0) resultsContainer.appendChild(document.createElement('hr')).className = 'cluster-separator';
                        if (cluster.shots && cluster.shots.length > 0) {
                            const sortedShots = [...cluster.shots].sort((a, b) => (a.shot_id || "").localeCompare(b.shot_id || ""));
                            const videoId = sortedShots[0].video_id;
                            const startShot = sortedShots[0].shot_id;
                            const endShot = sortedShots[sortedShots.length - 1].shot_id;
                            const header = document.createElement('div');
                            header.className = 'cluster-header asr-header';
                            let shotText = `Shot: ${startShot}`;
                            if (startShot !== endShot) { shotText = `Shots: ${startShot} - ${endShot}`; }
                            header.innerHTML = `<i class="fas fa-microphone"></i> ASR Results - Video: ${videoId} | ${shotText}`;
                            resultsContainer.appendChild(header);
                        }
                        const grid = document.createElement('div'); grid.className = 'results-grid';
                        (cluster.shots || []).forEach(shot => {
                            const item = document.createElement('div'); item.className = 'result-item';
                            item.innerHTML = createItemHTML(shot);
                            grid.appendChild(item);
                        });
                        resultsContainer.appendChild(grid);
                    });
                } else {
                    const header = document.createElement('div');
                    header.className = 'cluster-header asr-header';
                    header.innerHTML = `<i class="fas fa-microphone"></i> ASR Search Results`;
                    resultsContainer.appendChild(header);
                    
                    const grid = document.createElement('div'); grid.className = 'results-grid';
                    data.forEach(cluster => {
                        if (cluster.best_shot) {
                            const item = document.createElement('div'); item.className = 'result-item';
                            item.innerHTML = createItemHTML(cluster.best_shot);
                            grid.appendChild(item);
                        }
                    });
                    resultsContainer.appendChild(grid);
                }
            } else {
                if (isClusteredMode) {
                    data.forEach((cluster, index) => {
                        if (index > 0) resultsContainer.appendChild(document.createElement('hr')).className = 'cluster-separator';
                        if (cluster.shots && cluster.shots.length > 0) {
                            const sortedShots = [...cluster.shots].sort((a, b) => (a.shot_id || "").localeCompare(b.shot_id || ""));
                            const videoId = sortedShots[0].video_id;
                            const startShot = sortedShots[0].shot_id;
                            const endShot = sortedShots[sortedShots.length - 1].shot_id;
                            const header = document.createElement('div');
                            header.className = 'cluster-header';
                            let shotText = `Shot: ${startShot}`;
                            if (startShot !== endShot) { shotText = `Shots: ${startShot} - ${endShot}`; }
                            const headerIcon = searchType === 'ocr' ? 'fas fa-text-height' : 'fas fa-film';
                            const headerPrefix = searchType === 'ocr' ? 'OCR Results - ' : '';
                            header.innerHTML = `<i class="${headerIcon}"></i> ${headerPrefix}Video: ${videoId} | ${shotText}`;
                            resultsContainer.appendChild(header);
                        }
                        const grid = document.createElement('div'); grid.className = 'results-grid';
                        (cluster.shots || []).forEach(shot => {
                            const item = document.createElement('div'); item.className = 'result-item';
                            item.innerHTML = createItemHTML(shot);
                            grid.appendChild(item);
                        });
                        resultsContainer.appendChild(grid);
                    });
                } else {
                    const grid = document.createElement('div'); grid.className = 'results-grid';
                    data.forEach(cluster => {
                        if (cluster.best_shot) {
                            const item = document.createElement('div'); item.className = 'result-item';
                            item.innerHTML = createItemHTML(cluster.best_shot);
                            grid.appendChild(item);
                        }
                    });
                    resultsContainer.appendChild(grid);
                }
            }
        }
        
        addStage(); addStageBtn.addEventListener('click', addStage); removeStageBtn.addEventListener('click', removeStage); searchBtn.addEventListener('click', handleSearch);
        document.getElementById('resetBtn').addEventListener('click', () => { if (confirm('Are you sure?')) { stagesContainer.innerHTML = ''; addStage(); currentResults = []; searchType = null; displayResults(); } });
        window.addEventListener('keydown', (event) => {
            const activeElement = document.activeElement;
            const isTyping = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA');
            if (event.key === 'Enter' && !event.shiftKey) { 
                event.preventDefault();
                if (isTyping) { activeElement.blur(); searchBtn.click(); }
                else { const lastStage = stagesContainer.querySelector('.stage-card:last-child'); lastStage?.querySelector('.stage-input')?.focus(); }
                return;
            }
            if (isTyping) { return; }
            const key = event.key.toLowerCase();
            switch (key) {
                case 'g': clusterBtn.click(); break;
                case '=': case '+': addStageBtn.click(); break;
                case '-': removeStageBtn.click(); break;
                default:
                    const lastStage = stagesContainer.querySelector('.stage-card:last-child');
                    if (!lastStage) return;
                    switch(key) {
                        case 't': lastStage.querySelector('.type-btn[data-type="text"]')?.click(); break;
                        case 'i': lastStage.querySelector('.type-btn[data-type="image"]')?.click(); break;
                        case 'o': lastStage.querySelector('.type-btn[data-type="ocr"]')?.click(); break;
                        case 'a': lastStage.querySelector('.type-btn[data-type="asr"]')?.click(); break;
                        case 'q': lastStage.querySelector('.option-btn[data-option="enhance"]')?.click(); break;
                        case 'e': lastStage.querySelector('.option-btn[data-option="expand"]')?.click(); break;
                        default: return;
                    }
            }
            event.preventDefault();
        });
    });
    </script>
</body>
</html>