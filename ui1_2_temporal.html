<!-- FILE: ui/ui1.html (Updated with ASR search functionality) -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCubee2 Video Search System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS is unchanged */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #0f172a; color: #e2e8f0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .top-toolbar { position: fixed; top: 0; left: 0; width: 100%; background: rgba(15, 23, 42, 0.95); padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; z-index: 100; border-bottom: 1px solid rgba(94, 234, 212, 0.3); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); }
        .toolbar-left, .toolbar-right { display: flex; gap: 20px; align-items: center; }
        .toolbar-btn { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(94, 234, 212, 0.3); color: #5eead4; padding: 10px 18px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; font-size: 0.95rem; }
        .toolbar-btn:hover { background: rgba(56, 189, 248, 0.2); transform: translateY(-2px); color: #38bdf8; border-color: #38bdf8; }
        .app-title { font-size: 1.6rem; font-weight: 700; background: linear-gradient(to right, #38bdf8, #0ea5e9); -webkit-background-clip: text; background-clip: text; color: transparent; display: flex; align-items: center; gap: 10px; }
        .main-content-wrapper { display: flex; flex-grow: 1; padding-top: 75px; height: 100vh; }
        #left-search-panel { width: 450px; flex-shrink: 0; background: #0f172a; border-right: 1px solid rgba(94, 234, 212, 0.2); padding: 20px; display: flex; flex-direction: column; }
        #right-results-panel { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(94, 234, 212, 0.2); flex-shrink: 0; }
        .panel-title { font-size: 1.5rem; font-weight: 600; color: #38bdf8; }
        .stages-container { display: flex; flex-direction: column; gap: 20px; padding-top: 10px; overflow-y: auto; padding-right: 10px; flex-grow: 1; }
        .stage-card { background: rgba(30, 41, 59, 0.7); border-radius: 12px; padding: 20px; position: relative; border: 1px solid rgba(94, 234, 212, 0.2); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); flex-shrink: 0; }
        .stage-number { position: absolute; top: -12px; left: 20px; background: linear-gradient(to right, #0ea5e9, #38bdf8); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; color: white; }
        .stage-header { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; }
        .query-types { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .type-btn { background: rgba(30, 41, 59, 0.9); border: 1px solid rgba(94, 234, 212, 0.3); width: 40px; height: 40px; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; color: #94a3b8; }
        .type-btn.active { background: rgba(56, 189, 248, 0.2); border-color: #38bdf8; color: #38bdf8; transform: translateY(-3px); box-shadow: 0 4px 10px rgba(56, 189, 248, 0.3); }
        .type-btn:hover:not(.active) { border-color: #5eead4; color: #5eead4; }
        .delete-stage { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; width: 30px; height: 30px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .delete-stage:hover { background: rgba(239, 68, 68, 0.2); transform: scale(1.1); }
        .stage-input { width: 100%; padding: 14px 18px; background: rgba(15, 23, 42, 0.7); border: 1px solid rgba(94, 234, 212, 0.3); border-radius: 10px; color: white; font-size: 1.05rem; margin-top: 15px; }
        .stage-input:focus { outline: none; border-color: #38bdf8; box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2); }
        .panel-controls { display: flex; justify-content: space-between; align-items: center; margin-top: auto; flex-shrink: 0; padding-top: 20px; }
        .stage-controls { display: flex; gap: 15px; }
        .control-btn { width: 50px; height: 50px; border-radius: 12px; border: 1px solid rgba(94, 234, 212, 0.3); background: rgba(30, 41, 59, 0.7); color: #5eead4; font-size: 1.4rem; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .control-btn:hover { background: rgba(56, 189, 248, 0.2); transform: scale(1.05); color: #38bdf8; border-color: #38bdf8; }
        .search-btn { background: linear-gradient(to right, #0ea5e9, #38bdf8); color: white; border: none; padding: 14px 40px; border-radius: 12px; font-weight: 600; font-size: 1.1rem; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4); }
        .search-btn:hover { transform: translateY(-3px); box-shadow: 0 7px 20px rgba(14, 165, 233, 0.6); }
        #resultsContainer { display: flex; flex-direction: column; gap: 0; }
        .sequence-shots-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 12px;
        }
        .result-item { 
            background: rgba(30, 41, 59, 0.7); 
            border-radius: 10px;
            overflow: hidden; 
            border: 1px solid rgba(94, 234, 212, 0.2); 
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
        }
        .result-item:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(56, 189, 248, 0.2); }
        .result-item img { 
            width: 100%; 
            height: 110px;
            object-fit: cover; 
            display: block; 
            background-color: #1e293b; 
        }
        .result-item .info { 
            padding: 8px;
            font-size: 0.75rem;
        }
        .result-item .info p { margin: 0; line-height: 1.3; color: #94a3b8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .result-item .info .score { font-weight: bold; color: #5eead4; }
        .result-item .info .stage-title { font-weight: bold; color: #38bdf8; margin-bottom: 4px; font-size: 0.85rem; }
        .result-item .info .asr-text { color: #f59e0b; font-style: italic; white-space: normal; line-height: 1.2; max-height: 2.4em; overflow: hidden; }
    </style>
</head>
<body>
    <div class="top-toolbar">
        <div class="toolbar-left"><div class="app-title"><i class="fas fa-video"></i> OpenCubee</div></div>
        <div class="toolbar-right">
            <button class="toolbar-btn" id="resetBtn"><i class="fas fa-redo"></i> Reset Stages</button>
            <button class="toolbar-btn" id="exitBtn"><i class="fas fa-power-off"></i> Exit</button>
        </div>
    </div>
    <div class="main-content-wrapper">
        <div id="left-search-panel">
            <div class="panel-header"><h2 class="panel-title">Advanced Search Panel</h2></div>
            <div class="stages-container" id="stagesContainer"></div>
            <div class="panel-controls">
                <div class="stage-controls">
                    <button class="control-btn" id="addStageBtn" title="Add Stage"><i class="fas fa-plus"></i></button>
                    <button class="control-btn" id="removeStageBtn" title="Remove Stage"><i class="fas fa-minus"></i></button>
                </div>
                <button class="search-btn" id="searchBtn"><i class="fas fa-search"></i> Search</button>
            </div>
        </div>
        <div id="right-results-panel">
            <div id="loadingIndicator" style="display: none; text-align: center; font-size: 1.2rem; padding: 40px;">
                <i class="fas fa-spinner fa-spin"></i> Performing Search...
            </div>
            <div id="resultsContainer">
                <p style="text-align: center; color: #94a3b8; padding-top: 50px; font-size: 1.2rem;">Use the panel on the left to start a search.</p>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- VARIABLE DECLARATIONS ---
        const stagesContainer = document.getElementById('stagesContainer');
        const addStageBtn = document.getElementById('addStageBtn');
        const removeStageBtn = document.getElementById('removeStageBtn');
        const searchBtn = document.getElementById('searchBtn');
        const resetBtn = document.getElementById('resetBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const queryTypes = [
            { id: 'text', icon: 'fas fa-font', label: 'Text Query' },
            { id: 'image', icon: 'fas fa-image', label: 'Image Search' },
            { id: 'ocr', icon: 'fas fa-text-height', label: 'OCR Text Recognition' },
            { id: 'asr', icon: 'fas fa-microphone', label: 'Speech Recognition' },
            { id: 'object', icon: 'fas fa-shapes', label: 'Object Filter' }
        ];

        // --- UPDATED createStageCard FUNCTION TO HANDLE ASR ---
        function createStageCard(number) {
            const stageCard = document.createElement('div');
            stageCard.className = 'stage-card';
            let typesHTML = queryTypes.map(type => `<button class="type-btn ${type.id === 'text' ? 'active' : ''}" data-type="${type.id}" title="${type.label}"><i class="${type.icon}"></i></button>`).join('');
            stageCard.innerHTML = `<div class="stage-number">${number}</div><div class="stage-header"><div class="query-types">${typesHTML}</div><button class="delete-stage" title="Delete Stage"><i class="fas fa-times"></i></button></div><input type="text" class="stage-input" placeholder="Enter query for this stage..."><input type="file" class="stage-input-file" style="display: none; margin-top: 15px;" accept="image/*">`;
            stageCard.querySelector('.delete-stage').addEventListener('click', () => { stageCard.remove(); renumberStages(); });
            const typeButtons = stageCard.querySelectorAll('.type-btn');
            const textInput = stageCard.querySelector('.stage-input');
            const fileInput = stageCard.querySelector('.stage-input-file');
            typeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const type = button.dataset.type;
                    // Text, Image, OCR, ASR buttons are mutually exclusive
                    if (['text', 'image', 'ocr', 'asr'].includes(type)) {
                        typeButtons.forEach(btn => {
                            if (['text', 'image', 'ocr', 'asr'].includes(btn.dataset.type)) {
                                btn.classList.remove('active');
                            }
                        });
                        button.classList.add('active');
                    } else { // Other buttons (Object) are toggle
                        button.classList.toggle('active');
                    }
                    const imageIsActive = stageCard.querySelector('.type-btn[data-type="image"]').classList.contains('active');
                    textInput.style.display = imageIsActive ? 'none' : 'block';
                    fileInput.style.display = imageIsActive ? 'block' : 'none';
                    
                    // Update placeholder based on selected type
                    if (type === 'asr') {
                        textInput.placeholder = 'Enter speech/audio keywords to search...';
                    } else if (type === 'ocr') {
                        textInput.placeholder = 'Enter text to find in images...';
                    } else {
                        textInput.placeholder = 'Enter query for this stage...';
                    }
                });
            });
            return stageCard;
        }

        // --- HELPER FUNCTIONS REMAIN THE SAME ---
        function renumberStages() { stagesContainer.querySelectorAll('.stage-card').forEach((card, index) => { card.querySelector('.stage-number').textContent = index + 1; }); }
        function addStage() { stagesContainer.appendChild(createStageCard(stagesContainer.children.length + 1)); }
        function removeStage() { if (stagesContainer.children.length > 1) { stagesContainer.lastChild.remove(); } }

        // --- MAIN SEARCH HANDLER WITH ROUTING ---
        async function handleSearch() {
            const allStages = stagesContainer.querySelectorAll('.stage-card');
            if (allStages.length === 0) { alert('Please add at least one search stage.'); return; }
            
            loadingIndicator.style.display = 'block';
            resultsContainer.innerHTML = '';
            console.clear();

            // Check if this is a single-stage specialized search
            if (allStages.length === 1) {
                const firstStage = allStages[0];
                const isOcrSearch = firstStage.querySelector('.type-btn[data-type="ocr"].active');
                const isAsrSearch = firstStage.querySelector('.type-btn[data-type="asr"].active');

                if (isOcrSearch) {
                    console.log("DEBUG: Routing to OCR Search.");
                    await executeOcrSearch(firstStage);
                } else if (isAsrSearch) {
                    console.log("DEBUG: Routing to ASR Search.");
                    await executeAsrSearch(firstStage);
                } else {
                    console.log("DEBUG: Routing to Temporal Search.");
                    await executeTemporalSearch(allStages);
                }
            } else {
                console.log("DEBUG: Routing to Temporal Search.");
                await executeTemporalSearch(allStages);
            }
            loadingIndicator.style.display = 'none';
        }

        // --- OCR SEARCH FUNCTION ---
        async function executeOcrSearch(stage) {
            const query = stage.querySelector('.stage-input').value.trim();
            if (!query) {
                alert('Please enter keywords for OCR search.');
                return;
            }
            console.log("DEBUG: Starting OCR search with keyword:", query);
            try {
                const response = await fetch('/ocr_search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });
                if (!response.ok) { throw new Error(`Server error: ${response.status}`); }
                const results = await response.json();
                displayOcrResults(results, query);
            } catch (error) {
                console.error("DEBUG: OCR search error:", error);
                resultsContainer.innerHTML = `<p style="color: #ef4444;">Error occurred during OCR search. Check console (F12) for details.</p>`;
            }
        }

        // --- NEW: ASR SEARCH FUNCTION ---
        async function executeAsrSearch(stage) {
            const query = stage.querySelector('.stage-input').value.trim();
            if (!query) {
                alert('Please enter keywords for ASR search.');
                return;
            }
            console.log("DEBUG: Starting ASR search with keyword:", query);
            try {
                const response = await fetch('/asr_search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });
                if (!response.ok) { throw new Error(`Server error: ${response.status}`); }
                const results = await response.json();
                displayAsrResults(results, query);
            } catch (error) {
                console.error("DEBUG: ASR search error:", error);
                resultsContainer.innerHTML = `<p style="color: #ef4444;">Error occurred during ASR search. Check console (F12) for details.</p>`;
            }
        }

        // --- OCR RESULTS DISPLAY FUNCTION ---
        function displayOcrResults(results, query) {
            resultsContainer.innerHTML = ''; 
            if (!Array.isArray(results) || results.length === 0) {
                resultsContainer.innerHTML = `<p style="text-align: center; color: #94a3b8;">No OCR results found for "${query}".</p>`;
                return;
            }
            const mainGrid = document.createElement('div');
            mainGrid.className = 'sequence-shots-grid';
            results.forEach(item => {
                const resultElement = document.createElement('div');
                resultElement.className = 'result-item';
                resultElement.innerHTML = `
                    <img src="${item.url}" alt="OCR Result" loading="lazy" onerror="this.src='https://via.placeholder.com/150x110/1e293b/94a3b8?text=Not+Found'">
                    <div class="info" title="Video: ${item.video} | Shot: ${item.shot_id}\nOCR: ${item.ocr_text}">
                        <p class="stage-title" style="white-space: normal; line-height: 1.2;">${item.ocr_text}</p>
                        <p>Score: <span class="score">${item.score.toFixed(2)}</span></p>
                    </div>`;
                mainGrid.appendChild(resultElement);
            });
            resultsContainer.appendChild(mainGrid);
        }

        // --- NEW: ASR RESULTS DISPLAY FUNCTION ---
        function displayAsrResults(results, query) {
            resultsContainer.innerHTML = ''; 
            if (!Array.isArray(results) || results.length === 0) {
                resultsContainer.innerHTML = `<p style="text-align: center; color: #94a3b8;">No ASR results found for "${query}".</p>`;
                return;
            }
            const mainGrid = document.createElement('div');
            mainGrid.className = 'sequence-shots-grid';
            results.forEach(item => {
                const resultElement = document.createElement('div');
                resultElement.className = 'result-item';
                resultElement.innerHTML = `
                    <img src="${item.url}" alt="ASR Result" loading="lazy" onerror="this.src='https://via.placeholder.com/150x110/1e293b/94a3b8?text=Not+Found'">
                    <div class="info" title="Video: ${item.video} | Shot: ${item.shot_id}\nASR: ${item.asr_text}">
                        <p class="stage-title">🎤 Speech Recognition</p>
                        <p class="asr-text">${item.asr_text}</p>
                        <p>Score: <span class="score">${item.score.toFixed(2)}</span></p>
                    </div>`;
                mainGrid.appendChild(resultElement);
            });
            resultsContainer.appendChild(mainGrid);
        }

        // --- TEMPORAL SEARCH FUNCTIONS ---
        async function executeTemporalSearch(allStages) {
            const queries = [];
            for (const stage of allStages) {
                const textInput = stage.querySelector('.stage-input');
                if (textInput.value.trim() === '') {
                    alert(`Please enter keywords for stage ${stage.querySelector('.stage-number').textContent}.`);
                    return;
                }
                queries.push(textInput.value.trim());
            }
            console.log("DEBUG: Starting temporal search with keywords:", queries);
            try {
                const response = await fetch('/temporal_search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ queries: queries })
                });
                if (!response.ok) { throw new Error(`Server error: ${response.status}`); }
                const results = await response.json();
                displayTemporalResults(results, queries);
            } catch (error) {
                console.error("DEBUG: Temporal search error:", error);
                resultsContainer.innerHTML = `<p style="color: #ef4444;">An error occurred. Check console (F12) for details.</p>`;
            }
        }

        function displayTemporalResults(sequencesData, queries) {
            resultsContainer.innerHTML = ''; 
            if (!Array.isArray(sequencesData) || sequencesData.length === 0) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: #94a3b8;">No valid temporal sequences found.</p>';
                return;
            }
            const mainGrid = document.createElement('div');
            mainGrid.className = 'sequence-shots-grid';
            sequencesData.forEach((sequenceData) => {
                if (!sequenceData || !sequenceData.shots) { return; }
                sequenceData.shots.forEach((shot, stageIndex) => {
                    const item = document.createElement('div');
                    item.className = 'result-item';
                    item.innerHTML = `
                        <img src="${shot.url}" alt="Result for '${queries[stageIndex]}'" loading="lazy" onerror="this.src='https://via.placeholder.com/150x110/1e293b/94a3b8?text=Not+Found'">
                        <div class="info" title="Video: ${sequenceData.video_id}\nFilepath: ${shot.filepath}">
                            <p class="stage-title">Stage ${stageIndex + 1}: ${queries[stageIndex]}</p>
                            <p>Score: <span class="score">${shot.rrf_score.toFixed(4)}</span></p>
                        </div>`;
                    mainGrid.appendChild(item);
                });
            });
            if (mainGrid.hasChildNodes()) {
                resultsContainer.appendChild(mainGrid);
            } else {
                 resultsContainer.innerHTML = '<p style="text-align: center; color: #94a3b8;">No shots found in provided sequences.</p>';
            }
        }

        // --- EVENT LISTENERS ---
        addStage();
        addStageBtn.addEventListener('click', addStage);
        removeStageBtn.addEventListener('click', removeStage);
        searchBtn.addEventListener('click', handleSearch);
        resetBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to delete all stages?')) {
                stagesContainer.innerHTML = '';
                resultsContainer.innerHTML = '<p style="text-align: center; color: #94a3b8;">Use the left panel to start a search.</p>';
                addStage();
            }
        });
    });
    </script>
</body>
</html>