<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCubee Video Search System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --dark-bg: #0a0e1a;
            --card-bg: rgba(20, 25, 40, 0.85);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #b8c5d6;
            --accent-blue: #4facfe;
            --accent-purple: #667eea;
            --accent-pink: #f093fb;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --shadow-light: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-heavy: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body { 
            background: var(--dark-bg);
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(240, 147, 251, 0.1) 0%, transparent 50%);
            color: var(--text-primary); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
        }
        
        .top-toolbar { position: fixed; top: 0; left: 0; width: 100%; background: rgba(10, 14, 26, 0.95); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color); padding: 12px 32px; display: flex; justify-content: space-between; align-items: center; z-index: 100; box-shadow: var(--shadow-light); height: 80px; }
        .toolbar-left, .toolbar-right { display: flex; gap: 24px; align-items: center; }
        
        .app-title { font-size: 1.8rem; font-weight: 700; background: var(--primary-gradient); -webkit-background-clip: text; background-clip: text; color: transparent; display: flex; align-items: center; gap: 12px; text-shadow: 0 0 30px rgba(102, 126, 234, 0.5); }
        .app-logo { height: 65px; width: 65px; border-radius: 0%; object-fit: cover; }
        
        .model-btn-wrapper { position: relative; }
        
        .toolbar-btn { background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 12px 20px; border-radius: 12px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; gap: 10px; font-size: 0.95rem; font-weight: 500; position: relative; overflow: hidden; }
        .toolbar-btn .btn-hover-bg { position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: var(--primary-gradient); transition: left 0.3s ease; z-index: 0; }
        .toolbar-btn > span { position: relative; z-index: 1; display: flex; align-items: center; gap: 10px; }
        .toolbar-btn:hover .btn-hover-bg { left: 0; }
        .toolbar-btn:hover { transform: translateY(-2px); border-color: var(--accent-blue); box-shadow: 0 10px 25px rgba(79, 172, 254, 0.3); color: var(--text-primary); }
        .toolbar-btn.active { background: var(--success-gradient); border-color: var(--accent-blue); color: var(--text-primary); font-weight: 600; box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4); }
        .model-dropdown { display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: var(--card-bg); backdrop-filter: blur(20px); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: var(--shadow-heavy); padding: 12px; z-index: 101; width: 220px; }

        .main-content-wrapper { display: flex; flex-grow: 1; padding-top: 80px; height: 100vh; gap: 2px; }
        #left-search-panel { width: 380px; flex-shrink: 0; background: var(--card-bg); backdrop-filter: blur(20px); border-right: 1px solid var(--border-color); padding: 24px; display: flex; flex-direction: column; box-shadow: var(--shadow-light); }
        #right-results-panel { flex-grow: 1; overflow-y: auto; padding: 24px; background: rgba(10, 14, 26, 0.3); }
        .stages-container { display: flex; flex-direction: column; gap: 24px; padding-top: 24px; overflow-y: auto; padding-right: 12px; flex-grow: 1; }
        .stage-card { background: var(--glass-bg); backdrop-filter: blur(15px); border-radius: 16px; padding: 24px; position: relative; border: 1px solid var(--border-color); box-shadow: var(--shadow-light); flex-shrink: 0; transition: all 0.3s ease; }
        .stage-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-heavy); border-color: var(--accent-blue); }
        .stage-number { position: absolute; top: -14px; left: 0px; background: var(--primary-gradient); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); z-index: 1;}
        .stage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .query-types { display: flex; gap: 10px; }
        .type-btn { width: 44px; height: 44px; font-size: 1.1rem; background: var(--glass-bg); border: 1px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); position: relative; overflow: hidden; }
        .type-btn::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: var(--primary-gradient); border-radius: 50%; transition: all 0.3s ease; transform: translate(-50%, -50%); z-index: -1; }
        .type-btn.active::before { width: 200%; height: 200%; }
        .type-btn.active { background: transparent; border-color: var(--accent-blue); color: var(--text-primary); transform: translateY(-3px); box-shadow: 0 8px 20px rgba(79, 172, 254, 0.3); }
        .type-btn[data-type="asr"].active, .type-btn[data-type="ocr"].active { border-color: var(--accent-pink); box-shadow: 0 8px 20px rgba(240, 147, 251, 0.3); }
        .type-btn[data-type="asr"].active::before, .type-btn[data-type="ocr"].active::before { background: var(--secondary-gradient); }
        .type-btn:hover:not(.active) { border-color: var(--accent-purple); color: var(--accent-purple); transform: translateY(-2px); }
        
        .delete-stage { background: rgba(244, 63, 94, 0.1); border: 1px solid rgba(244, 63, 94, 0.3); color: #f43f5e; width: 36px; height: 36px; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .delete-stage:hover { background: rgba(244, 63, 94, 0.2); transform: scale(1.1) rotate(5deg); box-shadow: 0 4px 15px rgba(244, 63, 94, 0.3); }
        .stage-options { display: flex; gap: 12px; margin-top: 20px; }
        .option-btn { background: var(--glass-bg); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 8px 16px; border-radius: 10px; font-size: 0.85rem; cursor: pointer; transition: all 0.3s ease; font-weight: 500; }
        .option-btn.active { background: var(--success-gradient); border-color: var(--accent-blue); color: var(--text-primary); font-weight: 600; box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3); }
        .option-btn:hover:not(.active) { border-color: var(--accent-blue); color: var(--accent-blue); transform: translateY(-1px); }
        .panel-controls { display: flex; justify-content: space-between; align-items: center; margin-top: auto; flex-shrink: 0; padding-top: 24px; border-top: 1px solid var(--border-color); }
        .stage-controls { display: flex; gap: 16px; }
        .control-btn { width: 54px; height: 54px; border-radius: 14px; border: 1px solid var(--border-color); background: var(--glass-bg); color: var(--text-secondary); font-size: 1.4rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .control-btn:hover { background: var(--primary-gradient); transform: scale(1.05) translateY(-2px); color: var(--text-primary); border-color: var(--accent-blue); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
        .search-btn { background: var(--primary-gradient); color: white; border: none; padding: 16px 32px; border-radius: 14px; font-weight: 600; font-size: 1.1rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; gap: 12px; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); position: relative; overflow: hidden; }
        .search-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
        .search-btn:hover::before { left: 100%; }
        .search-btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6); }
        .query-input-area { margin-top: 15px; position: relative; }
        .stage-input { width: 100%; padding: 12px 16px; background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-size: 1.0rem; line-height: 1.5; resize: vertical; transition: all 0.3s ease; font-family: inherit; }
        .main-query-input { min-height: 80px; }
        .stage-input:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2); background: rgba(79, 172, 254, 0.05); }
        .stage-input-file { display: none; }
        .image-upload-zone { display: none; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 160px; border: 2px dashed var(--border-color); border-radius: 12px; background: var(--glass-bg); color: var(--text-secondary); cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; backdrop-filter: blur(10px); }
        .image-upload-zone.dragover { border-color: var(--accent-blue); background: rgba(79, 172, 254, 0.1); transform: scale(1.02); }
        .image-upload-zone:hover { border-color: var(--accent-purple); background: rgba(102, 126, 234, 0.05); }
        .image-upload-zone i { font-size: 2.5rem; margin-bottom: 10px; }
        .image-upload-zone p { font-size: 0.9rem; text-align: center; }
        .image-preview { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        .remove-image-btn { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255, 255, 255, 0.3); color: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; font-size: 0.9rem; z-index: 2; }
        .remove-image-btn:hover { background: #ef4444; color: white; border-color: transparent; }
        
        .model-dropdown-item { display: flex; align-items: center; padding: 12px 16px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        .model-dropdown-item:hover { background: var(--glass-bg); }
        .model-dropdown-item.focused {
            background: var(--glass-bg);
            outline: 2px solid var(--accent-blue);
            outline-offset: -2px;
        }
        .model-dropdown-item input[type="checkbox"] { margin-right: 10px; accent-color: var(--accent-blue); }
        .model-dropdown-item label { cursor: pointer; user-select: none; }
        
        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
        .result-item { background: var(--card-bg); backdrop-filter: blur(15px); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); aspect-ratio: 16 / 9; cursor: pointer; position: relative; }
        .result-item:hover { transform: scale(1.03) translateY(-4px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); border-color: var(--accent-blue); }
        .result-item img { width: 100%; height: 100%; object-fit: cover; display: block; transition: transform 0.3s ease; }
        .result-item:hover img { transform: scale(1.05); }
        
        .cluster-separator { border: 0; height: 1px; background: var(--border-color); margin: 30px 0 20px 0; }
        .cluster-header { color: var(--accent-blue); font-size: 1.2rem; font-weight: 600; margin-bottom: 16px; padding: 16px 20px; background: var(--glass-bg); backdrop-filter: blur(15px); border-radius: 12px; border: 1px solid var(--border-color); display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow-light); }
        .cluster-header i { font-size: 1.2rem; }
        .cluster-header.asr-header { color: var(--accent-pink); background: rgba(240, 147, 251, 0.05); border-color: rgba(240, 147, 251, 0.2); }
        .sequence-header { color: var(--text-secondary); font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; padding: 12px 18px; border-left: 3px solid var(--accent-purple); background: var(--glass-bg); backdrop-filter: blur(15px); border-radius: 12px; box-shadow: var(--shadow-light); display: flex; align-items: center; gap: 10px; }
        .temporal-cluster-header { color: #e2e8f0; font-size: 1.0rem; font-weight: 500; margin-bottom: 15px; margin-top: 15px; display: flex; align-items: center; gap: 10px; }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); backdrop-filter: blur(25px); border: 1px solid var(--border-color); width: 90%; max-width: 1200px; max-height: 90vh; border-radius: 20px; box-shadow: var(--shadow-heavy); display: flex; flex-direction: column; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.5rem; color: var(--accent-blue); }
        .modal-close { font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); transition: color 0.2s; }
        .modal-close:hover { color: #ef4444; }
        .modal-body { padding: 25px; display: flex; gap: 30px; overflow-y: auto; }
        .filter-section { flex: 1; display: flex; flex-direction: column; }
        .filter-section-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .filter-section-title { font-size: 1.2rem; color: var(--accent-blue); }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #475569; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background: var(--accent-blue); }
        input:checked + .slider:before { transform: translateX(22px); }
        .filter-controls-container { display: flex; flex-direction: column; gap: 15px; }
        .count-filter-row { display: grid; grid-template-columns: 30px 1fr 120px; align-items: center; gap: 10px; cursor: pointer; padding: 8px; border-radius: 8px; border: 1px solid transparent; transition: background-color 0.2s, border-color 0.2s; }
        .count-filter-row:hover { background-color: rgba(79, 172, 254, 0.1); }
        .count-filter-row.active-row { background-color: rgba(79, 172, 254, 0.15); border-color: rgba(79, 172, 254, 0.4); }
        .count-filter-row.custom { grid-template-columns: 30px 1fr 120px 30px; }
        .count-filter-row input[type=checkbox] { accent-color: var(--accent-blue); width: 18px; height: 18px; cursor: pointer; }
        .count-filter-row label { font-size: 1rem; color: var(--text-primary); }
        .filter-input { background: rgba(10, 14, 26, 0.8); border: 1px solid var(--border-color); color: white; border-radius: 6px; padding: 8px 10px; font-size: 0.95rem; }
        .filter-input:focus { outline: none; border-color: var(--accent-blue); }
        .add-custom-btn, .remove-custom-btn { background: none; border: 1px solid var(--border-color); color: var(--text-secondary); width: 30px; height: 30px; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .add-custom-btn:hover, .remove-custom-btn:hover { border-color: var(--accent-blue); color: var(--accent-blue); }
        #positioningCanvas { background: #1e293b; border-radius: 10px; cursor: crosshair; touch-action: none; }
        .drawn-boxes-list { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .drawn-box-item { display: flex; align-items: center; justify-content: space-between; background: #1e293b; padding: 8px; border-radius: 6px; }
        .drawn-box-item.active { border-left: 3px solid var(--accent-blue); }
        .shortcuts-info { font-size: 0.8rem; color: var(--text-secondary); margin-top: 10px; line-height: 1.6; }

        .image-modal-overlay { display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.95); backdrop-filter: blur(20px); align-items: center; justify-content: center; }
        .image-modal-content { margin: auto; display: block; max-width: 90vw; max-height: 90vh; animation: modalZoom 0.4s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 12px; box-shadow: var(--shadow-heavy); }
        @keyframes modalZoom { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .image-modal-close { position: absolute; top: 20px; right: 40px; color: var(--text-primary); font-size: 24px; font-weight: bold; transition: all 0.3s ease; cursor: pointer; z-index: 2101; background: rgba(0, 0, 0, 0.5); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .image-modal-close:hover { color: var(--accent-pink); transform: scale(1.1) rotate(90deg); background: rgba(244, 63, 94, 0.2); }
        
        #temporalContextModal { z-index: 2000; }
        #imageModal { z-index: 2100; }
        #temporalContextModal .temporal-modal-content { background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 16px; width: 95%; max-width: 1600px; height: auto; max-height: 95vh; display: flex; flex-direction: column; box-shadow: var(--shadow-heavy); animation: modalZoom 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        #temporalContextModal .temporal-modal-header { padding: 16px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        #temporalContextModal #temporalModalTitle { font-size: 1.2rem; font-weight: 600; color: var(--text-primary); }
        #temporalContextModal .image-modal-close { position: static; width: 36px; height: 36px; font-size: 1.2rem; }
        #temporalContextModal .temporal-modal-body { padding: 24px; overflow-y: auto; flex-grow: 1; }
        .temporal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; }
        .temporal-grid-item { position: relative; background-color: var(--glass-bg); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; aspect-ratio: 16 / 9; cursor: pointer; transition: all 0.2s ease-in-out; }
        .temporal-grid-item:hover { transform: scale(1.05); border-color: var(--accent-blue); z-index: 10; }
        .temporal-grid-item.center-frame { border: 2px solid var(--accent-purple); box-shadow: 0 0 15px rgba(102, 126, 234, 0.6); }
        .temporal-grid-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .temporal-item-label { position: absolute; top: 4px; left: 4px; background-color: rgba(0, 0, 0, 0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        #temporalContextModal .temporal-modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-color); text-align: center; font-size: 0.9rem; color: var(--text-secondary); flex-shrink: 0; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--primary-gradient); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--secondary-gradient); }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        #loadingIndicator { animation: pulse 2s infinite; color: var(--accent-blue); font-size: 1.4rem;}
        #loadingIndicator i { margin-right: 10px; }

        .enhanced-query-display-wrapper {
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(79, 172, 254, 0.1);
            border-radius: 8px;
            border-left: 3px solid var(--accent-blue);
            transition: all 0.3s ease;
        }
        .enhanced-query-display-wrapper small {
            font-weight: 600;
            color: var(--accent-blue);
            display: block;
            margin-bottom: 4px;
            font-size: 0.8rem;
        }
        .enhanced-query-display {
            color: var(--text-secondary);
            font-style: italic;
            font-size: 0.95rem;
            line-height: 1.4;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="top-toolbar">
        <div class="toolbar-left">
            <div class="app-title">
                <img src="/static/logo.png" alt="OpenCubee Logo" class="app-logo">
                <span>OpenCubee</span>
            </div>
        </div>
        <div class="toolbar-right">
            <div class="model-btn-wrapper">
                <button id="modelSelectBtn" class="toolbar-btn" title="Toggle Models (Ctrl+M)">
                    <div class="btn-hover-bg"></div>
                    <span><i class="fas fa-layer-group"></i> Models</span>
                </button>
                <div id="modelDropdown" class="model-dropdown">
                    <div class="model-dropdown-item"><input type="checkbox" id="model-beit3" value="beit3" checked><label for="model-beit3">BEiT-3</label></div>
                    <div class="model-dropdown-item"><input type="checkbox" id="model-bge" value="bge" checked><label for="model-bge">BGE-VL</label></div>
                    <div class="model-dropdown-item"><input type="checkbox" id="model-unite" value="unite" checked><label for="model-unite">Unite</label></div>
                </div>
            </div>
            
            <button class="toolbar-btn" id="objectFilterBtn" title="Object Filters (Ctrl+F to open, Alt+F to toggle)">
                <div class="btn-hover-bg"></div>
                <span><i class="fas fa-shapes"></i> Filters</span>
            </button>
            <button class="toolbar-btn active" id="clusterBtn" title="Toggle Clustering (Ctrl+G)">
                <div class="btn-hover-bg"></div>
                <span><i class="fas fa-object-group"></i> Cluster</span>
            </button>
            <button class="toolbar-btn" id="resetBtn">
                <div class="btn-hover-bg"></div>
                <span><i class="fas fa-redo"></i> Reset Search</span>
            </button>
        </div>
    </div>
    <div class="main-content-wrapper">
        <div id="left-search-panel">
            <div class="stages-container" id="stagesContainer"></div>
            <div class="panel-controls">
                <div class="stage-controls">
                    <button class="control-btn" id="addStageBtn" title="Add Stage (Ctrl+])"><i class="fas fa-plus"></i></button>
                    <button class="control-btn" id="removeStageBtn" title="Remove Stage (Ctrl+[)"><i class="fas fa-minus"></i></button>
                </div>
                <button class="search-btn" id="searchBtn" title="Search (Enter from input)"><i class="fas fa-search"></i> Search</button>
            </div>
        </div>
        <div id="right-results-panel">
            <div id="loadingIndicator" style="display: none; text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Performing Search...</div>
            <div id="resultsContainer"><p style="text-align: center; color: var(--text-secondary); padding-top: 50px; font-size: 1.2rem;">Sử dụng bảng điều khiển bên trái để bắt đầu tìm kiếm.</p></div>
        </div>
    </div>
    
    <div id="objectFilterModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title"><i class="fas fa-shapes"></i> Object Filters</h2><span class="modal-close" id="modalCloseBtn">&times;</span></div>
            <div class="modal-body">
                <div class="filter-section">
                    <div class="filter-section-header"><h3 class="filter-section-title">Object Counting</h3><label class="switch"><input type="checkbox" id="enableCountFilter"><span class="slider"></span></label></div>
                    <div id="countFilterControls" class="filter-controls-container"></div>
                     <button class="add-custom-btn" id="addCustomCountBtn" style="margin-top: 15px; width: 100%;"><i class="fas fa-plus"></i> Add Custom Object</button>
                </div>
                <div class="filter-section">
                    <div class="filter-section-header"><h3 class="filter-section-title">Object Positioning</h3><label class="switch"><input type="checkbox" id="enablePositionFilter"><span class="slider"></span></label></div>
                    <div class="position-controls">
                        <canvas id="positioningCanvas" width="640" height="360"></canvas>
                        <div id="drawnBoxesList" class="drawn-boxes-list"></div>
                        <p class="shortcuts-info"><b>Shortcuts:</b> Draw box with mouse. <br><b>1-6:</b> person, car, truck, dog, cat, toaster. <b>7:</b> Custom. <br><b>Backspace:</b> Delete last box. <b>C:</b> Clear all.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="imageModal" class="image-modal-overlay">
        <span class="image-modal-close" title="Close (Esc)">&times;</span>
        <img class="image-modal-content" id="zoomedImage">
    </div>

    <div id="temporalContextModal" class="image-modal-overlay">
        <div class="temporal-modal-content">
            <div class="temporal-modal-header">
                <h2 id="temporalModalTitle"></h2>
                <span class="image-modal-close" id="closeTemporalModalBtn" title="Close (Esc)">&times;</span>
            </div>
            <div class="temporal-modal-body">
                <div class="temporal-grid" id="temporalGrid"></div>
            </div>
            <div class="temporal-modal-footer">
                Hướng dẫn: Click để zoom, Ctrl+Click để xem bối cảnh, Ctrl+Shift+Click để tìm kiếm bằng ảnh này.
            </div>
        </div>
    </div>

    <script>
        function urlSafeB64Encode(str) {
            try {
                const utf8Bytes = new TextEncoder().encode(str);
                let binaryString = '';
                utf8Bytes.forEach(byte => { binaryString += String.fromCharCode(byte); });
                return btoa(binaryString).replace(/\+/g, '-').replace(/\//g, '_');
            } catch (e) {
                console.error("Failed to encode string:", str, e); return "";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const stagesContainer = document.getElementById('stagesContainer');
            const addStageBtn = document.getElementById('addStageBtn');
            const removeStageBtn = document.getElementById('removeStageBtn');
            const searchBtn = document.getElementById('searchBtn');
            const resultsContainer = document.getElementById('resultsContainer');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const modelSelectBtn = document.getElementById('modelSelectBtn');
            const modelDropdown = document.getElementById('modelDropdown');
            const clusterBtn = document.getElementById('clusterBtn');
            const objectFilterBtn = document.getElementById('objectFilterBtn');
            const objectFilterModal = document.getElementById('objectFilterModal');
            const modalCloseBtn = document.getElementById('modalCloseBtn');
            const imageModal = document.getElementById('imageModal');
            const zoomedImage = document.getElementById('zoomedImage');
            const closeImageModalBtn = document.querySelector('#imageModal .image-modal-close');
            const temporalContextModal = document.getElementById('temporalContextModal');
            const temporalGrid = document.getElementById('temporalGrid');
            const temporalModalTitle = document.getElementById('temporalModalTitle');
            const closeTemporalModalBtn = document.getElementById('closeTemporalModalBtn');
            const enableCountFilter = document.getElementById('enableCountFilter');
            const enablePositionFilter = document.getElementById('enablePositionFilter');
            const countFilterControls = document.getElementById('countFilterControls');
            const addCustomCountBtn = document.getElementById('addCustomCountBtn');
            const posCanvas = document.getElementById('positioningCanvas');
            const drawnBoxesList = document.getElementById('drawnBoxesList');
            const posCtx = posCanvas.getContext('2d');
            
            // State
            let currentResults = [];
            let drawnBoxes = [];
            let isDrawing = false;
            let startX, startY, currentX, currentY;
            const PREDEFINED_OBJECTS = ['person', 'car', 'truck', 'dog', 'cat', 'cow', 'toaster'];
            const LABEL_SHORTCUTS = { '1': 'person', '2': 'car', '3': 'truck', '4': 'dog', '5': 'cat', '6': 'toaster'};
            let focusedModelIndex = -1;

            // --- Helper Functions ---
            function clearModelFocus() {
                modelDropdown.querySelectorAll('.model-dropdown-item').forEach(item => item.classList.remove('focused'));
                focusedModelIndex = -1;
            }

            function updateModelFocus() {
                const items = modelDropdown.querySelectorAll('.model-dropdown-item');
                items.forEach((item, index) => {
                    item.classList.toggle('focused', index === focusedModelIndex);
                });
            }
            
            function focusOnStageInput(stageElement) {
                if (!stageElement) return;
                const input = stageElement.querySelector('.main-query-input');
                if (input) {
                    input.focus();
                    input.setSelectionRange(input.value.length, input.value.length);
                }
            }


            // --- Stage Creation ---
            function createStageCard(number) {
                const stageCard = document.createElement('div');
                stageCard.className = 'stage-card';
                stageCard.dataset.stageNumber = number;

                stageCard.innerHTML = `
                    <div class="stage-number">${number}</div>
                    <div class="stage-header">
                        <div class="query-types">
                            <button class="type-btn active" data-type="text" title="Text (Ctrl+H)"><i class="fas fa-font"></i></button>
                            <button class="type-btn" data-type="image" title="Image (Ctrl+J)"><i class="fas fa-image"></i></button>
                            <button class="type-btn" data-type="ocr" data-basetype="filter" title="OCR Filter (Ctrl+K)"><i class="fas fa-text-height"></i></button>
                            <button class="type-btn" data-type="asr" data-basetype="filter" title="ASR Filter (Ctrl+L)"><i class="fas fa-microphone"></i></button>
                        </div>
                        ${number > 1 ? '<button class="delete-stage" title="Delete Stage"><i class="fas fa-times"></i></button>' : ''}
                    </div>
                    <div class="query-input-area">
                        <div class="text-query-wrapper">
                            <textarea class="stage-input main-query-input" placeholder="Nhập truy vấn văn bản..." rows="3"></textarea>
                            <div class="enhanced-query-display-wrapper" style="display: none;">
                                <small>Enhanced Query:</small>
                                <p class="enhanced-query-display"></p>
                            </div>
                        </div>

                        <div class="image-query-wrapper" style="display: none;">
                            <label for="file-input-${number}" class="image-upload-zone">
                                <div class="upload-instructions"><i class="fas fa-cloud-upload-alt"></i><p>Kéo & thả ảnh hoặc <strong>nhấn để chọn file</strong></p></div>
                                <img class="image-preview" style="display: none;"><button class="remove-image-btn" style="display: none;" title="Xóa ảnh"><i class="fas fa-times"></i></button>
                            </label>
                            <input type="file" id="file-input-${number}" class="stage-input-file" accept="image/*">
                            <div class="image-fusion-text-wrapper">
                                <input type="text" class="stage-input image-fusion-text-input" placeholder="Tùy chọn: Thêm văn bản để hướng dẫn tìm kiếm ảnh...">
                            </div>
                        </div>

                        <div class="filter-input-wrapper" data-filter-type="ocr" style="display: none; margin-top: 10px;">
                            <input type="text" class="stage-input ocr-filter-input" placeholder="Lọc theo từ khóa OCR...">
                        </div>
                        <div class="filter-input-wrapper" data-filter-type="asr" style="display: none; margin-top: 10px;">
                            <input type="text" class="stage-input asr-filter-input" placeholder="Lọc theo từ khóa ASR...">
                        </div>
                    </div>
                    <div class="stage-options">
                        <button class="option-btn" data-option="enhance" title="Enhance Query (Ctrl+Q)">Enhance Query</button>
                        <button class="option-btn" data-option="expand" title="Expand Query (Ctrl+E)">Expand Query</button>
                    </div>`;

                // --- Event Listeners ---
                const textQueryWrapper = stageCard.querySelector('.text-query-wrapper');
                const imageQueryWrapper = stageCard.querySelector('.image-query-wrapper');
                const stageOptions = stageCard.querySelector('.stage-options'); // Enhance/Expand buttons

                // 1. Query type buttons (Text, Image, OCR, ASR)
                stageCard.querySelectorAll('.type-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const type = button.dataset.type;
                        const baseType = button.dataset.basetype;

                        if (baseType !== 'filter') {
                            stageCard.querySelectorAll('.type-btn[data-basetype!="filter"]').forEach(btn => btn.classList.remove('active'));
                            button.classList.add('active');
                            
                            const isText = type === 'text';
                            textQueryWrapper.style.display = isText ? 'block' : 'none';
                            imageQueryWrapper.style.display = isText ? 'none' : 'block';
                            stageOptions.style.display = isText ? 'flex' : 'none'; // Show options only for text
                        } else { // 'filter'
                            button.classList.toggle('active');
                            const filterWrapper = stageCard.querySelector(`.filter-input-wrapper[data-filter-type="${type}"]`);
                            filterWrapper.style.display = button.classList.contains('active') ? 'block' : 'none';
                            if (button.classList.contains('active')) {
                                filterWrapper.querySelector('input').focus();
                            }
                        }
                    });
                });
                
                // 2. Option buttons (Enhance, Expand) - Just toggle the class now
                stageCard.querySelectorAll('.option-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        button.classList.toggle('active');
                    });
                });
                
                // 3. File upload and other events
                const handleFileSelect = (file) => { if (file && file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = e => { const previewImage = stageCard.querySelector('.image-preview'), uploadInstructions = stageCard.querySelector('.upload-instructions'), removeImageBtn = stageCard.querySelector('.remove-image-btn'); previewImage.src = e.target.result; previewImage.style.display = 'block'; uploadInstructions.style.display = 'none'; removeImageBtn.style.display = 'flex'; }; reader.readAsDataURL(file); stageCard.selectedImageFile = file; } }; 
                stageCard.querySelector('.remove-image-btn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); stageCard.querySelector('.stage-input-file').value = ''; const previewImage = stageCard.querySelector('.image-preview'), uploadInstructions = stageCard.querySelector('.upload-instructions'), removeImageBtn = stageCard.querySelector('.remove-image-btn'); previewImage.src = ''; previewImage.style.display = 'none'; uploadInstructions.style.display = 'block'; removeImageBtn.style.display = 'none'; delete stageCard.selectedImageFile; }); 
                stageCard.querySelector('.stage-input-file').addEventListener('change', e => handleFileSelect(e.target.files[0])); 
                const dropZone = stageCard.querySelector('.image-upload-zone'); dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); }); dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.classList.remove('dragover'); }); dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFileSelect(e.dataTransfer.files[0]); }); 
                stageCard.querySelector('.delete-stage')?.addEventListener('click', () => { stageCard.remove(); renumberStages(); }); 

                return stageCard;
            }
            
            // --- NEW: Function to process a single query before sending to backend ---
            async function processQueryForSearch(stageCard) {
                const mainTextInput = stageCard.querySelector('.main-query-input');
                const enhanceBtn = stageCard.querySelector('.option-btn[data-option="enhance"]');
                const expandBtn = stageCard.querySelector('.option-btn[data-option="expand"]');
                const displayWrapper = stageCard.querySelector('.enhanced-query-display-wrapper');
                const displayP = stageCard.querySelector('.enhanced-query-display');
                
                const originalQuery = mainTextInput.value.trim();
                if (!originalQuery) {
                    displayWrapper.style.display = 'none';
                    return { finalQuery: '', expand: expandBtn.classList.contains('active') };
                }

                // Decide if enhancement is needed
                const isNonEnglish = /[^\u0000-\u007F]/.test(originalQuery);
                let shouldEnhance = enhanceBtn.classList.contains('active') || isNonEnglish;

                if (!shouldEnhance) {
                    displayWrapper.style.display = 'none';
                    return { finalQuery: originalQuery, expand: expandBtn.classList.contains('active') };
                }

                // If enhancement is needed, call the API
                displayWrapper.style.display = 'block';
                displayP.textContent = 'Processing...';

                try {
                    const response = await fetch('/process_query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query: originalQuery,
                            enhance: true, // Always enhance if this block is reached
                            expand: expandBtn.classList.contains('active')
                        })
                    });
                    if (!response.ok) throw new Error('Server returned an error during query processing');

                    const data = await response.json();
                    const processedQuery = data.processed_query;

                    if (processedQuery && processedQuery !== originalQuery) {
                        displayP.textContent = processedQuery;
                        // Automatically activate the button if enhancement happened
                        enhanceBtn.classList.add('active');
                    } else {
                        displayWrapper.style.display = 'none';
                    }
                    // Return the processed query. Expand is handled by the API now.
                    return { finalQuery: processedQuery, expand: expandBtn.classList.contains('active') };

                } catch (error) {
                    console.error('Error processing query:', error);
                    displayWrapper.style.display = 'none';
                    // Fallback to original query on error
                    return { finalQuery: originalQuery, expand: expandBtn.classList.contains('active') };
                }
            }


            // --- Search Logic (REWRITTEN) ---
            async function handleSearch() {
                const allStages = stagesContainer.querySelectorAll('.stage-card');
                if (allStages.length === 0) { alert('Vui lòng thêm ít nhất một stage tìm kiếm.'); return; }
                
                loadingIndicator.style.display = 'block';
                resultsContainer.innerHTML = '';
                currentResults = [];

                try {
                    const objectFilters = getObjectFilterData();
                    let response;

                    if (allStages.length === 1) {
                        const firstStage = allStages[0];
                        const formData = new FormData();
                        let searchData = {
                            query_text: null, ocr_query: null, asr_query: null,
                            models: [], expand: false, filters: objectFilters
                        };
                        let hasPrimaryQuery = false;

                        // Check query type
                        if (firstStage.querySelector('.type-btn[data-type="text"].active')) {
                            const { finalQuery, expand } = await processQueryForSearch(firstStage);
                            searchData.query_text = finalQuery;
                            searchData.expand = expand;
                            searchData.models = Array.from(document.querySelectorAll('#modelDropdown input:checked')).map(cb => cb.value);
                            if (searchData.query_text) hasPrimaryQuery = true;

                        } else if (firstStage.querySelector('.type-btn[data-type="image"].active')) {
                            const imageFile = firstStage.selectedImageFile;
                            if (imageFile) {
                                formData.append('query_image', imageFile, imageFile.name);
                                // Get optional fusion text and force model to BGE
                                const imageFusionText = firstStage.querySelector('.image-fusion-text-input').value.trim();
                                searchData.query_text = imageFusionText || null;
                                searchData.models = ['bge']; // Force BGE model for image search
                                hasPrimaryQuery = true;
                            }
                        }

                        // Get OCR/ASR filters
                        if (firstStage.querySelector('.type-btn[data-type="ocr"].active')) {
                            searchData.ocr_query = firstStage.querySelector('.ocr-filter-input').value.trim();
                        }
                        if (firstStage.querySelector('.type-btn[data-type="asr"].active')) {
                            searchData.asr_query = firstStage.querySelector('.asr-filter-input').value.trim();
                        }
                        
                        if (!hasPrimaryQuery && !searchData.ocr_query && !searchData.asr_query) {
                            throw new Error("Vui lòng cung cấp truy vấn chính (text/ảnh) hoặc bộ lọc (OCR/ASR).");
                        }
                        if (hasPrimaryQuery && searchData.models.length === 0) {
                            throw new Error("Vui lòng chọn ít nhất một model cho tìm kiếm chính.");
                        }

                        formData.append('search_data', JSON.stringify(searchData));
                        response = await fetch('/search', { method: 'POST', body: formData });

                    } else { // >= 2 stages (Temporal Search - Logic remains the same)
                        const stagesData = [];
                        for (const stage of allStages) {
                            const { finalQuery, expand } = await processQueryForSearch(stage);
                            if (finalQuery === '') throw new Error(`Vui lòng nhập truy vấn cho Stage ${stage.dataset.stageNumber}.`);
                            stagesData.push({ query: finalQuery, expand: expand });
                        }
                        
                        const firstStage = allStages[0];
                        const ocrQuery = firstStage.querySelector('.type-btn[data-type="ocr"].active') ? firstStage.querySelector('.ocr-filter-input').value.trim() : null;
                        const asrQuery = firstStage.querySelector('.type-btn[data-type="asr"].active') ? firstStage.querySelector('.asr-filter-input').value.trim() : null;
                        const selectedModels = Array.from(document.querySelectorAll('#modelDropdown input:checked')).map(cb => cb.value);

                        const payload = { 
                            stages: stagesData, 
                            models: selectedModels, 
                            cluster: clusterBtn.classList.contains('active'),
                            filters: objectFilters,
                            ocr_query: ocrQuery,
                            asr_query: asrQuery
                        };
                        
                        response = await fetch('/temporal_search', { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify(payload) 
                        });
                    }
                    
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || 'Lỗi không xác định từ server.');
                    }
                    currentResults = await response.json();
                    displayResults();

                } catch (error) {
                    console.error("[ERROR] Search failed:", error);
                    resultsContainer.innerHTML = `<p style="color: #ef4444; font-size: 1.1rem; text-align: center;"><strong>Lỗi:</strong> ${error.message}</p>`;
                } finally {
                    loadingIndicator.style.display = 'none';
                }
            }
            
            // --- Object Filter Logic ---
            function getObjectFilterData() {
                const filters = {};
                if (enableCountFilter.checked) {
                    const conditions = {};
                    countFilterControls.querySelectorAll('.count-filter-row').forEach(row => {
                        const checkbox = row.querySelector('.count-checkbox');
                        if (checkbox.checked) {
                            const conditionInput = row.querySelector('.condition-input').value.trim();
                            if (conditionInput) {
                                let objectName = row.classList.contains('custom') ? row.querySelector('.custom-object-name').value.trim().toLowerCase() : checkbox.dataset.object;
                                if (objectName) conditions[objectName] = conditionInput;
                            }
                        }
                    });
                    if (Object.keys(conditions).length > 0) filters.counting = { conditions };
                }
                if (enablePositionFilter.checked && drawnBoxes.length > 0) {
                    const boxes = drawnBoxes.filter(b => b.label).map(b => ({ label: b.label, box: [ b.x / posCanvas.width, b.y / posCanvas.height, (b.x + b.w) / posCanvas.width, (b.y + b.h) / posCanvas.height ] }));
                    if (boxes.length > 0) filters.positioning = { boxes };
                }
                objectFilterBtn.classList.toggle('active', enableCountFilter.checked || enablePositionFilter.checked);
                return (enableCountFilter.checked || enablePositionFilter.checked) && Object.keys(filters).length > 0 ? filters : null;
            }
            
            function createCountRow(objectName = '', isCustom = false) {
                const row = document.createElement('div');
                row.className = 'count-filter-row' + (isCustom ? ' custom' : '');
                const checkboxHTML = `<input type="checkbox" class="count-checkbox" data-object="${objectName || 'custom'}">`;
                const labelHTML = isCustom ? `<input type="text" class="filter-input custom-object-name" placeholder="object name">` : `<label>${objectName}</label>`;
                const conditionHTML = `<input type="text" class="filter-input condition-input" placeholder="e.g., >=1">`;
                const removeBtnHTML = isCustom ? `<button class="remove-custom-btn">&times;</button>` : '';
                row.innerHTML = `${checkboxHTML}${labelHTML}${conditionHTML}${removeBtnHTML}`;
                const checkbox = row.querySelector('.count-checkbox');
                const syncRowStyle = () => row.classList.toggle('active-row', checkbox.checked);
                row.addEventListener('click', (e) => { if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') { checkbox.checked = !checkbox.checked; syncRowStyle(); } });
                checkbox.addEventListener('change', syncRowStyle);
                if (isCustom) row.querySelector('.remove-custom-btn').addEventListener('click', () => row.remove());
                syncRowStyle();
                return row;
            }
            PREDEFINED_OBJECTS.forEach(obj => countFilterControls.appendChild(createCountRow(obj)));
            addCustomCountBtn.addEventListener('click', () => countFilterControls.appendChild(createCountRow('', true)));

            // --- Canvas Drawing Logic ---
            function redrawCanvas() {
                if (!posCtx) return;
                posCtx.clearRect(0, 0, posCanvas.width, posCanvas.height);
                posCtx.strokeStyle = 'var(--accent-blue)'; posCtx.lineWidth = 2;
                drawnBoxes.forEach((box, index) => {
                    posCtx.strokeRect(box.x, box.y, box.w, box.h);
                    posCtx.font = "14px 'Poppins'"; posCtx.fillStyle = 'var(--accent-blue)';
                    posCtx.fillText(`${index + 1}: ${box.label || 'no label'}`, box.x + 5, box.y + 16);
                });
                if (isDrawing) { posCtx.strokeStyle = 'var(--accent-pink)'; posCtx.strokeRect(startX, startY, currentX - startX, currentY - startY); }
            }
            function updateDrawnBoxesList() {
                drawnBoxesList.innerHTML = '';
                drawnBoxes.forEach((box, index) => { const item = document.createElement('div'); item.className = 'drawn-box-item'; item.textContent = `Box ${index + 1}: ${box.label || '(unlabeled)'}`; drawnBoxesList.appendChild(item); });
            }
            posCanvas.addEventListener('pointerdown', (e) => { isDrawing = true; startX = e.offsetX; startY = e.offsetY; });
            posCanvas.addEventListener('pointermove', (e) => { if (!isDrawing) return; currentX = e.offsetX; currentY = e.offsetY; redrawCanvas(); });
            posCanvas.addEventListener('pointerup', (e) => {
                if (!isDrawing) return; isDrawing = false; const endX = e.offsetX; const endY = e.offsetY;
                const box = { x: Math.min(startX, endX), y: Math.min(startY, endY), w: Math.abs(endX - startX), h: Math.abs(endY - startY), label: '' };
                if (box.w > 5 && box.h > 5) { drawnBoxes.push(box); }
                redrawCanvas(); updateDrawnBoxesList();
            });

            // --- Display and Interaction Logic ---
            const handleItemClick = (event, shot) => {
                event.preventDefault(); event.stopPropagation();
                if (event.ctrlKey && event.shiftKey) { performImageSearchFromClick(shot); }
                else if (event.ctrlKey || event.metaKey) { openTemporalContextView(shot); }
                else { imageModal.style.display = 'flex'; zoomedImage.src = shot.url; }
            };

            async function openTemporalContextView(shot) {
                if (!shot || !shot.filepath) { alert("Error: Invalid data for context view."); return; }
                temporalModalTitle.textContent = `Loading context for Video: ${shot.video_id}, Frame: ${shot.frame_id}...`;
                temporalGrid.innerHTML = '<p style="color: white; text-align: center; padding: 20px;">Checking available frames...</p>';
                temporalContextModal.style.display = 'flex';
                try {
                    const response = await fetch('/check_temporal_frames', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ base_filepath: shot.filepath }) });
                    if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.detail || 'Failed to check frames.'); }
                    const existingFiles = await response.json();
                    if (existingFiles.length === 0) { temporalGrid.innerHTML = '<p style="color: #ffcccc; text-align: center;">No context frames found.</p>'; return; }
                    temporalModalTitle.textContent = `Frame Context – Video: ${shot.video_id || 'N/A'}, Frame: ${shot.frame_id || 'N/A'}`;
                    temporalGrid.innerHTML = ''; 
                    const centerFrameMatch = shot.filepath.match(/_(\d+)\./);
                    const centerFrameNum = centerFrameMatch ? parseInt(centerFrameMatch[1], 10) : null;
                    existingFiles.forEach(currentFilepath => {
                        const encodedPath = urlSafeB64Encode(currentFilepath);
                        if (!encodedPath) return;
                        const imageUrl = `/images/${encodedPath}`;
                        const gridItem = document.createElement('div'); gridItem.className = 'temporal-grid-item';
                        const label = document.createElement('div'); label.className = 'temporal-item-label';
                        const currentFrameMatch = currentFilepath.match(/_(\d+)\./);
                        if (currentFrameMatch && centerFrameNum !== null) {
                            const offset = parseInt(currentFrameMatch[1], 10) - centerFrameNum;
                            label.textContent = offset > 0 ? `+${offset}` : `${offset}`;
                            if (offset === 0) gridItem.classList.add('center-frame');
                        }
                        const img = document.createElement('img'); img.src = imageUrl; img.alt = `Frame from ${shot.video_id}`; img.title = `Click: Zoom\nCtrl+Click: View context\nCtrl+Shift+Click: Search with this image\n\nFile: ${currentFilepath}`; img.onerror = () => { gridItem.style.display = 'none'; };
                        gridItem.appendChild(label); gridItem.appendChild(img);
                        const frameIdMatch = currentFilepath.match(/_(\d+)\.[^.]+$/);
                        const thisSpecificShot = { url: imageUrl, filepath: currentFilepath, video_id: shot.video_id, shot_id: shot.shot_id, frame_id: frameIdMatch ? parseInt(frameIdMatch[1], 10) : null };
                        gridItem.addEventListener('click', (e) => handleItemClick(e, thisSpecificShot));
                        temporalGrid.appendChild(gridItem);
                    });
                } catch (error) {
                    console.error("Error loading context view:", error);
                    temporalGrid.innerHTML = `<p style="color: #ffcccc; text-align: center;">Error: ${error.message}</p>`;
                }
            }

            async function performImageSearchFromClick(shot) {
                if (!shot || !shot.url || !shot.filepath) { alert('Invalid data for image search.'); return; }
                if (temporalContextModal.style.display === 'flex') { temporalContextModal.style.display = 'none'; }
                console.log(`[IMAGE SEARCH] Initiating from click. Image: ${shot.filepath}`);
                stagesContainer.innerHTML = ''; addStage();
                const newStage = stagesContainer.querySelector('.stage-card');
                newStage.querySelector('.type-btn[data-type="image"]').click();
                const uploadInstructions = newStage.querySelector('.upload-instructions');
                uploadInstructions.innerHTML = '<p>Loading image for search...</p>';
                try {
                    const response = await fetch(shot.url);
                    if (!response.ok) throw new Error(`Failed to fetch image: ${response.statusText}`);
                    const blob = await response.blob();
                    const filename = shot.filepath.split('/').pop() || 'clicked-image.jpg';
                    newStage.selectedImageFile = new File([blob], filename, { type: blob.type });
                    const previewImage = newStage.querySelector('.image-preview');
                    const removeImageBtn = newStage.querySelector('.remove-image-btn');
                    previewImage.src = URL.createObjectURL(blob); 
                    previewImage.style.display = 'block';
                    uploadInstructions.style.display = 'none';
                    removeImageBtn.style.display = 'flex';
                    await handleSearch();
                } catch (error) {
                    console.error('Error in image search from click:', error);
                    alert(`An error occurred: ${error.message}`);
                    uploadInstructions.parentElement.querySelector('.upload-instructions').style.display = 'block';
                    uploadInstructions.parentElement.querySelector('.upload-instructions p').textContent = 'Drag & drop image or click to browse';
                    uploadInstructions.parentElement.querySelector('.image-preview').style.display = 'none';
                }
            }
        
            function displayResults() {
                resultsContainer.innerHTML = '';
                const data = currentResults;
                if (!Array.isArray(data) || data.length === 0) {
                    resultsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Không tìm thấy kết quả.</p>';
                    return;
                }

                const isClusteredMode = clusterBtn.classList.contains('active');

                const createItemTitle = (shot) => {
                    if (!shot) return '';
                    let title = `Click: Zoom\nCtrl+Click: Xem bối cảnh\nCtrl+Shift+Click: Tìm kiếm bằng ảnh này\n\nFilepath: ${shot.filepath || 'N/A'}\nShot ID: ${shot.shot_id || 'N/A'}`;
                    const score = shot.rrf_score || shot.cluster_score || shot.score;
                    if (score) title += `\nScore: ${score.toFixed(4)}`;
                    if (shot.caption_text) title += `\nCaption: ${shot.caption_text}`;
                    return title;
                };
                
                const createItemHTML = (shot) => {
                    if (!shot || !shot.url) return '';
                    return `<img src="${shot.url}" alt="Search Result" title="${createItemTitle(shot)}" loading="lazy" onerror="this.parentElement.style.display='none'">`;
                };
                
                if (data[0] && (data[0].average_rrf_score !== undefined || (data[0].clusters && stagesContainer.querySelectorAll('.stage-card').length > 1))) {
                    data.forEach((sequence, index) => {
                        if (index > 0) resultsContainer.appendChild(document.createElement('hr')).className = 'cluster-separator';
                        const seqHeader = document.createElement('div');
                        seqHeader.className = 'sequence-header';
                        seqHeader.innerHTML = `<i class="fas fa-stream"></i> Sequence ${index + 1} (Video: ${sequence.video_id || 'N/A'})`;
                        resultsContainer.appendChild(seqHeader);

                        if (isClusteredMode && sequence.clusters) {
                            sequence.clusters.forEach((cluster, clusterIndex) => {
                                const clusterHeader = document.createElement('div');
                                clusterHeader.className = 'temporal-cluster-header';
                                clusterHeader.innerHTML = `<i class="fas fa-object-group"></i> <strong>Stage ${clusterIndex + 1} Cluster:</strong> Shots ${cluster.min_shot_id} - ${cluster.max_shot_id}`;
                                resultsContainer.appendChild(clusterHeader);
                                const grid = document.createElement('div');
                                grid.className = 'results-grid';
                                const sortedShots = [...(cluster.shots || [])].sort((a, b) => a.filepath && b.filepath ? a.filepath.localeCompare(b.filepath) : 0);
                                sortedShots.forEach(shot => {
                                    const item = document.createElement('div');
                                    item.className = 'result-item';
                                    item.innerHTML = createItemHTML(shot);
                                    item.addEventListener('click', (e) => handleItemClick(e, shot));
                                    grid.appendChild(item);
                                });
                                resultsContainer.appendChild(grid);
                            });
                        } else { 
                            const grid = document.createElement('div');
                            grid.className = 'results-grid';
                            (sequence.shots || []).forEach(shot => {
                                const item = document.createElement('div');
                                item.className = 'result-item';
                                item.innerHTML = createItemHTML(shot);
                                item.addEventListener('click', (e) => handleItemClick(e, shot));
                                grid.appendChild(item);
                            });
                            resultsContainer.appendChild(grid);
                        }
                    });
                } 
                else { // Single Stage Search Results
                    if (isClusteredMode) {
                        data.forEach((cluster, index) => {
                            if (index > 0) resultsContainer.appendChild(document.createElement('hr')).className = 'cluster-separator';
                            const clusterHeader = document.createElement('div');
                            clusterHeader.className = 'cluster-header';
                            const bestShot = cluster.best_shot;
                            clusterHeader.innerHTML = bestShot ? `<i class="fas fa-object-group"></i> Cluster ${index + 1} (Video: ${bestShot.video_id} - Shot: ${bestShot.shot_id})` : `<i class="fas fa-object-group"></i> Cluster ${index + 1}`;
                            resultsContainer.appendChild(clusterHeader);
                            const grid = document.createElement('div');
                            grid.className = 'results-grid';
                            const sortedShots = [...(cluster.shots || [])].sort((a, b) => a.filepath && b.filepath ? a.filepath.localeCompare(b.filepath) : 0);
                            sortedShots.filter(Boolean).forEach(shot => {
                                const item = document.createElement('div');
                                item.className = 'result-item';
                                item.innerHTML = createItemHTML(shot);
                                item.addEventListener('click', (e) => handleItemClick(e, shot));
                                grid.appendChild(item);
                            });
                            resultsContainer.appendChild(grid);
                        });
                    } else {
                        const grid = document.createElement('div');
                        grid.className = 'results-grid';
                        const flatList = data.flatMap(item => item.shots ? item.shots : (item.best_shot ? [item.best_shot] : (item ? [item] : [])));
                        const uniqueShots = Array.from(new Map(flatList.filter(Boolean).map(shot => [shot.filepath, shot])).values());
                        
                        uniqueShots.forEach(shot => {
                            const item = document.createElement('div');
                            item.className = 'result-item';
                            item.innerHTML = createItemHTML(shot);
                            item.addEventListener('click', (e) => handleItemClick(e, shot));
                            grid.appendChild(item);
                        });
                        resultsContainer.appendChild(grid);
                    }
                }
            }

            // --- Initialization & Event Listeners ---
            function renumberStages() { stagesContainer.querySelectorAll('.stage-card').forEach((card, index) => card.querySelector('.stage-number').textContent = index + 1); }
            
            function addStage() {
                const newStage = createStageCard(stagesContainer.children.length + 1);
                stagesContainer.appendChild(newStage);
                return newStage;
            }

            function removeStage() {
                if (stagesContainer.children.length > 1) {
                    stagesContainer.lastChild.remove();
                    focusOnStageInput(stagesContainer.lastChild);
                }
            }

            focusOnStageInput(addStage()); // Initial stage with focus
            
            addStageBtn.addEventListener('click', () => {
                const newStage = addStage();
                focusOnStageInput(newStage);
            });
            removeStageBtn.addEventListener('click', removeStage);

            searchBtn.addEventListener('click', handleSearch);
            document.getElementById('resetBtn').addEventListener('click', () => { if (confirm('Are you sure you want to reset the search panel?')) { stagesContainer.innerHTML = ''; const newStage = addStage(); focusOnStageInput(newStage); currentResults = []; resultsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Use the left panel to start a search.</p>'; } });
            clusterBtn.addEventListener('click', () => { clusterBtn.classList.toggle('active'); if (currentResults.length > 0) displayResults(); });
            
            modelSelectBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                const isOpening = modelDropdown.style.display !== 'block';
                modelDropdown.style.display = isOpening ? 'block' : 'none';
                if (isOpening) {
                    focusedModelIndex = 0;
                    updateModelFocus();
                } else {
                    clearModelFocus();
                }
            });

            window.addEventListener('click', (e) => {
                if (!modelDropdown.contains(e.target) && !modelSelectBtn.contains(e.target)) {
                    if (modelDropdown.style.display === 'block') {
                        modelDropdown.style.display = 'none';
                        clearModelFocus();
                    }
                }
            });

            // Modals
            closeImageModalBtn.addEventListener('click', () => { imageModal.style.display = "none"; });
            imageModal.addEventListener('click', (e) => { if (e.target === imageModal) { imageModal.style.display = "none"; } });
            closeTemporalModalBtn.addEventListener('click', () => { temporalContextModal.style.display = "none"; });
            temporalContextModal.addEventListener('click', (e) => { if (e.target === temporalContextModal) { temporalContextModal.style.display = "none"; } });
            modalCloseBtn.addEventListener('click', () => objectFilterModal.style.display = 'none');
            objectFilterBtn.addEventListener('click', () => objectFilterModal.style.display = 'flex');

            // --- KEYDOWN SHORTCUTS (UPDATED) ---
            window.addEventListener('keydown', (event) => {
                const isImageModalVisible = imageModal.style.display === 'flex';
                const isTemporalModalVisible = temporalContextModal.style.display === 'flex';
                const isObjectModalVisible = objectFilterModal.style.display === 'flex';
                const isModelDropdownVisible = modelDropdown.style.display === 'block';

                if (event.key === 'Escape') {
                    event.preventDefault(); 
                    if (isImageModalVisible) { imageModal.style.display = 'none'; return; }
                    if (isTemporalModalVisible) { temporalContextModal.style.display = 'none'; return; }
                    if (isObjectModalVisible) { objectFilterModal.style.display = 'none'; return; }
                    if (isModelDropdownVisible) { 
                        modelDropdown.style.display = 'none';
                        clearModelFocus();
                        return;
                    }
                }
                
                if (isModelDropdownVisible) {
                    const items = modelDropdown.querySelectorAll('.model-dropdown-item');
                    if (items.length > 0) {
                        switch (event.key) {
                            case 'ArrowDown': event.preventDefault(); focusedModelIndex = (focusedModelIndex + 1) % items.length; updateModelFocus(); break;
                            case 'ArrowUp': event.preventDefault(); focusedModelIndex = (focusedModelIndex - 1 + items.length) % items.length; updateModelFocus(); break;
                            case 'Enter': event.preventDefault(); if (focusedModelIndex > -1) { items[focusedModelIndex].querySelector('input[type="checkbox"]')?.click(); } break;
                            case 'Tab': event.preventDefault(); break;
                        }
                    }
                    if (['ArrowDown', 'ArrowUp', 'Enter', 'Tab'].includes(event.key)) return;
                }

                const activeElement = document.activeElement;
                const isTyping = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA');
                const key = event.key.toLowerCase();

                if (key === 'enter' && !event.shiftKey) {
                    if (isTyping && activeElement.classList.contains('stage-input')) { 
                        event.preventDefault(); searchBtn.click(); 
                    }
                    return;
                }
            
                if (isObjectModalVisible && !isTyping && drawnBoxes.length > 0) {
                    if (event.key in LABEL_SHORTCUTS) { event.preventDefault(); drawnBoxes[drawnBoxes.length - 1].label = LABEL_SHORTCUTS[event.key]; } 
                    else if (event.key === '7') { event.preventDefault(); const customLabel = prompt("Enter custom object label:", "person"); if (customLabel) drawnBoxes[drawnBoxes.length - 1].label = customLabel.toLowerCase(); } 
                    else if (event.key === 'Backspace') { event.preventDefault(); drawnBoxes.pop(); } 
                    else if (key === 'c') { event.preventDefault(); if (confirm("Clear all drawn boxes?")) drawnBoxes = []; }
                    redrawCanvas(); updateDrawnBoxesList();
                }
            
                if (event.altKey && key === 'f') { 
                    event.preventDefault(); 
                    const areAnyFiltersOn = enableCountFilter.checked || enablePositionFilter.checked;
                    const newState = !areAnyFiltersOn;
                    enableCountFilter.checked = newState;
                    enablePositionFilter.checked = newState;
                    getObjectFilterData();
                    return; 
                }
            
                if (event.ctrlKey || event.metaKey) {
                    const targetStageNum = parseInt(event.key);
                    if (!isNaN(targetStageNum) && targetStageNum >= 1 && targetStageNum <= 9) {
                        event.preventDefault();
                        let allStages = stagesContainer.querySelectorAll('.stage-card');
                        while (allStages.length < targetStageNum) {
                            addStage();
                            allStages = stagesContainer.querySelectorAll('.stage-card');
                        }
                        const targetStageElement = allStages[targetStageNum - 1];
                        focusOnStageInput(targetStageElement);
                        return; 
                    }
                    
                    let handled = true;
                    const stageToModify = isTyping ? activeElement.closest('.stage-card') : stagesContainer.querySelector('.stage-card:last-child');
                    switch (key) {
                        case 'm': modelSelectBtn.click(); break;
                        case ']': {
                            const newStage = addStage();
                            focusOnStageInput(newStage);
                            break;
                        }
                        case '[':
                            removeStage();
                            break;
                        case 'g': clusterBtn.click(); break; 
                        case 'f': objectFilterBtn.click(); break;
                        case 'h': stageToModify?.querySelector('.type-btn[data-type="text"]')?.click(); break;
                        case 'j': stageToModify?.querySelector('.type-btn[data-type="image"]')?.click(); break;
                        case 'k': stageToModify?.querySelector('.type-btn[data-type="ocr"]')?.click(); break;
                        case 'l': stageToModify?.querySelector('.type-btn[data-type="asr"]')?.click(); break;
                        case 'q': stageToModify?.querySelector('.option-btn[data-option="enhance"]')?.click(); break;
                        case 'e': stageToModify?.querySelector('.option-btn[data-option="expand"]')?.click(); break;
                        default: handled = false;
                    }
                    if (handled) event.preventDefault();
                }
            });
        });
    </script>
</body>
</html>